---
title: "Paleomat Figures"
author: "Andrew Gillreath-Brown"
date: "10/20/2021"
output: bookdown::word_document2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(paleomat)
library(maps)
data(us.cities)

```

# Figures

```{r fig1, fig.cap= "Temperature for the North Atlantic using Greenland ice core data (Alley 2000) for 20,000 BP to present.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}
# Greenland ice core data (used in Huckleberry 2015) from Alley 2000.

alley2000 <-
  read.csv(file = "data-raw/gisp2_temp_accum_alley2000.csv", header = TRUE) %>%
  dplyr::mutate(Age = Age * 1000)  %>%
  dplyr::filter(Age <= 20000)

alley2000 %>%
  ggplot(aes(x = Age, y = Temperature)) +
  geom_line() +
  scale_x_reverse(breaks = seq(0, 20000, 2500)) +
  theme_classic() +
  xlab("calibrated years BP") +
  ylab("Temperature °C") +
  annotate(
    "rect",
    xmin = 11500,
    xmax = 12800,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 12150,
    y = -27.25,
    label = "Younger \n Dryas",
    size = 3.5
  ) +
  geom_segment(aes(
    x = 8200,
    y = -36.5,
    xend = 8200,
    yend = -33
  ),
  arrow = arrow(length = unit(0.3, "cm"))) +
  annotate(
    "text",
    x = 8200,
    y = -38,
    label = "8200 cal yr BP \n cold event",
    size = 3
  ) +
  annotate(
    "rect",
    xmin = 4000,
    xmax = 6000,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 5000,
    y = -27.25,
    label = "northward expansion \n of agriculture",
    size = 3
  ) 

# Warmest periods following 5000 BP.
# 3297.07     -28.748
# 2068.24    -29.5708
# 1514.860    -30.4060
# 964.939    -30.4628



alley2000 %>%
  dplyr::filter(Age <= 3000) %>% 
  dplyr::mutate(date = BPtoBCAD(Age)) %>% 
  ggplot(aes(x = date, y = Temperature)) +
  geom_line() +
  scale_x_continuous(breaks = seq(-1200, 2000, 200)) +
  theme_classic() +
  xlab("calibrated years BP") +
  ylab("Temperature °C") 


```


```{r fig2, fig.cap="Low-frequency component of Moberg et al. (2005) multi-proxy reconstruction for Northern Hemisphere for 1817-25 BP.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Moberg et al. 2005 low-frequency reconstruction (only).
Moberg <-
  read.delim(
    "./data-raw/nhtemp-moberg2005.txt",
    header = TRUE,
    sep = "\t",
    dec = "."
  ) [, 1:3] %>%
  dplyr::filter(LF != -9.9999 & date <= 2000) %>%
  dplyr::mutate(date = 1950 - date)

ggplot(data = Moberg, aes(x = date, y = LF)) +
  geom_line(size = 1.5) +
  xlab("calibrated years BP") +
  ylab("Temperature Anomaly (°C)") +
  #scale_x_continuous(breaks=seq(0,2000,200), minor_breaks = seq(100, 1900, 200)) +
  scale_x_reverse(breaks = seq(0, 2000, 200),
                  minor_breaks = seq(100, 1900, 200)) +
  scale_y_continuous(breaks = seq(-0.8, 0, 0.1), limits = c(-0.8, 0)) +
  theme_bw() +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "grey 70"),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 10,
      b = 5,
      l = 5
    )
  )
```

```{r fig3, fig.cap="Locations of fossil pollen samples used in this study over the mean July temperature for 1961 to 1990 from PRISM at 800-m resolution. The grey box indicates the extent of the Upper United States Southwest (Bocinsky and Kohler 2014), and the red box shows the extent of the reconstruction in this study.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Showing extent of UUSS and the fossil pollen sites.

# Get locations of the fossil pollen sites.
fossil.locs <-
  readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>%
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(site.name) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(site.id, site.name, long, lat)

# Get the PRISM modern July temperature dataset.
modern_temp <-
  brick(
    "/Volumes/PUCK_HD/Users/andrew/Dropbox/WSU/SKOPEII/Figures/PRISM_tavg_monthly_normals.tif"
  ) %>%
  raster::subset(7)

temp.raster <-
  raster::projectRaster(modern_temp, crs = CRS("+init=epsg:4326"))

# bbox_buffer <- c(
#   "xmin" = min(fossil.locs$long) - 1,
#   "ymin" = min(fossil.locs$lat) - 1,
#   "xmax" = max(fossil.locs$long) + 1,
#   "ymax" = max(fossil.locs$lat) + 1
# )  %>%
#   sf::st_bbox() %>%
#   sf::st_as_sfc() %>%
#   sf::st_as_sf(crs = 4326) %>%
#   sf::st_transform(crs = 4326)
#
# temp.raster.cropped <- raster::crop(temp.raster, bbox_buffer)

# Create a bounding box for the upper united states southwest
bb <-
  c(
    "xmin" = -113,
    "xmax" = -105,
    "ymin" = 32,
    "ymax" = 38.09
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

usa <- sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
usa <- sf::st_transform(usa, crs = 4326)

cities2 <- us.cities %>%
  dplyr::select(name, long, lat) %>%
  dplyr::filter(
    name %in% c(
      "Farmington NM",
      "Santa Fe NM",
      "Albuquerque NM",
      "Flagstaff AZ",
      "Phoenix AZ"
    )
  ) %>%
  dplyr::add_row(name = "Mesa Verde CO",
                 long = -108.463050,
                 lat = 37.230299)

cities <- cities2  %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

fossil.sites <- fossil.locs %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

crs(temp.raster) <-
  "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
temperature <- as.data.frame(temp.raster, xy = TRUE)
temperature_transformed <- usmap::usmap_transform(temperature)

# Create a bounding box for limits of this study
bb2 <-
  c(
    "xmin" = -112.81446,
    "xmax" = -105.52416,
    "ymin" = 32.65757,
    "ymax" = 38.089
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)


ggplot() +
  geom_raster(
    data = temperature_transformed,
    aes(x = x, y = y, fill = PRISM_tavg_monthly_normals.7),
    alpha = 0.8,
    na.rm = TRUE
  ) +
  scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                       #limits = c(-8, 8),
                       na.value = "transparent",
                       name = "Temperature °C") +
  coord_equal() +
  theme_classic() +
  scale_x_continuous(breaks = seq(-115,-103, 2.0),
                     limits = c(-115,-103.2)) +
  scale_y_continuous(breaks = seq(31, 39, 2.0),
                     limits = c(31.25, 39)) +
  geom_sf(
    data = usa,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.5
  ) +
  geom_sf(
    data = fossil.sites,
    shape = 20,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = cities,
    shape = 23,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = bb,
    size = 1,
    fill = NA,
    colour = "dark grey",
    alpha = 0.3
  ) +
  geom_sf(
    data = bb2,
    size = 1,
    fill = NA,
    colour = "red",
    alpha = 0.3
  ) +
  shadowtext::geom_shadowtext(
    data = cities2,
    aes(x = long, y = lat, label = name),
    nudge_y = 0.265,
    color = "white",
    size = 2.5
  ) +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 10,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black"),
    legend.text = element_text(size = 10, family = "Helvetica"),
    legend.title = element_text(size = 11, family = "Helvetica")
  )



```

```{r fig4, fig.cap="Low-frequency temperature reconstruction time series for this study.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}


# Temperature anomaly across time for the spatial extent in each 100 year interval.
temp_anom <- read.csv("./output/paleomat-temp-anomaly-final.csv")

temp_anom %>%
  ggplot() +
  geom_line(aes(x = year, y = anom), colour = "red", size = 1.0) +
  xlab("Year BC/AD") +
  ylab("July Temperature Anomaly (°C)") +
  scale_x_continuous(breaks = seq(-1000, 1800, 200),
                     minor_breaks = seq((-1000 + 100), (1800 - 100), 200)) +
  # scale_y_continuous(breaks = seq(-2.5, 0.0, 0.5),
  #                    limits = c(-2.5, 0.0)) +
  theme_bw() +
  annotate(
    "rect",
    xmin = 800,
    xmax = 1200,
    ymin = -2.5,
    ymax = 0.0,
    alpha = .2
  ) +
  annotate(
    "text",
    x = 1000,
    y = -0.25,
    label = "Medieval Warm \n Period",
    size = 4.5
  ) +
    annotate(
    "rect",
    xmin = 1400,
    xmax = 1800,
    ymin = -2.5,
    ymax = 0.0,
    alpha = .2
  ) +
  annotate(
    "text",
    x = 1600,
    y = -0.25,
    label = "Little Ice \n Age",
    size = 4.5
  ) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 6,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 6,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black")
  )


```


```{r fig5, fig.cap="July temperature anomaly from AD 100 to 1800 from this study and of Moberg et al. [2005]. Both time series have been standardized so that they can be compared using (x-mean/std) where x is temperature, the mean is of the individual time series, and the standard deviation is of the individual time series.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

temp_anom_standard <- anom_new %>%
  dplyr::mutate(update = (anom - mean(anom_new$anom)) / sd(anom_new$anom)) %>% 
  dplyr::mutate(Series = "This study") %>% 
  dplyr::select(year, update, Series)

Moberg_standard <- Moberg %>% 
  dplyr::mutate(update = (LF - mean(Moberg$LF)) / sd(Moberg$LF)) %>% 
  dplyr::mutate(year = BPtoBCAD(date)) %>% 
  dplyr::mutate(Series = "Moberg et al. 2005") %>% 
  dplyr::select(year, update, Series)

Moberg_paleomat <- rbind(temp_anom_standard, Moberg_standard)

# Moberg LF and paleomat
Moberg_paleomat %>% 
  dplyr::filter(year >= 133 & year <= 1800) %>% 
  ggplot(aes(x = year, y = update, colour = Series)) +
  geom_line() +
  xlab("Year BC/AD") +
  ylab("Standardized July Temperature Anomaly") +
  theme_bw() +
  scale_x_continuous(breaks = seq(100, 1800, 100))

```


```{r fig6, fig.cap="The spatial interpolation of the low-frequency temperature reconstruction for this study. The extent can be seen by the red box in Figure 3.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# tavg_rasters <- brick("./output/paleomat-rasters.tif") %>%
#   unstack()

# library(ggnewscale)
# 
# # setting up bounding box
# locations <- data.frame(x = c(-112.81446, -105.52416),
#                         y = c(32.65757, 38.089))

# -112.81446,
#     "xmax" = -105.52416,
#     "ymin" = 32.65757,
#     "ymax" = 38.089

# # get gem
# dem <- get_elev_raster(locations = bb2, prj = sf::st_crs(4326), z = 7, clip = "bbox")
# temp.raster <- raster::crop(temp.raster, bb2)
# temp.raster <-
#   raster::projectRaster(temp.raster, crs = CRS("+init=epsg:4326"))
# 
# # create slope and hillshade
# slope = terrain(dem, opt='slope')
# aspect = terrain(dem, opt='aspect')
# hill = hillShade(slope, aspect, 40, 270)
# hill_spdf <- as(hill, "SpatialPixelsDataFrame")
# hill_spdf <- as.data.frame(hill_spdf)
# colnames(hill_spdf) <- c("value", "x", "y")


rasterVis::gplot(tavg_idw_stack) +
  # geom_tile(data = hill_spdf, aes(x = x, y = y, fill = value)) +
  geom_tile(aes(fill = value)) +
  facet_wrap(~ variable) +
  scale_fill_gradientn(colours = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255)) +
  coord_equal() +
  theme_bw()


# names(tavg_idw) <- c("BC950","BC850","BC750", "BC650", "BC550","BC450", "BC350", "BC250", "BC150", "BC50", "AD50", "AD150", "AD250", "AD350", "AD450", "AD550", "AD650", "AD750", "AD850","AD950", "AD1050", "AD1150", "AD1250", "AD1350", "AD1450", "AD1550", "AD1650", "AD1750")
#
# anomaly_plots <-
#   purrr::map2(
#     .x = tavg_idw, .y = names(tavg_idw),
#     .f =
#       ~plot_map_anomaly(x = .x, x.name = .y, us.cities = us.cities, cities = FALSE, animation = FALSE)
#   )


# temp.raster <-
#   raster::projectRaster(tavg_nrg[[23]], crs = CRS("+init=epsg:4326"))
# 
# 
# usa <- sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
# usa <- sf::st_transform(usa, crs = 4326)
# 
# crs(temp.raster) <-
#   "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
# temperature <- as.data.frame(temp.raster, xy = TRUE)
# temperature_transformed <- usmap::usmap_transform(temperature)
# 
# 
# ggplot() +
#   geom_raster(
#     data = temperature_transformed,
#     aes(x = x, y = y, fill = paleomat.rasters.23),
#     alpha = 0.8,
#     na.rm = TRUE
#   ) +
#   scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
#                        #limits = c(-8, 8),
#                        na.value = "transparent",
#                        name = "Temperature °C") +
#   coord_equal() +
#   theme_classic()


```



```{r fig7, fig.cap="July temperature anomaly for two Village Ecodynamics Project (VEP) areas, VEPIIS and VEPIIN (Schwindt et al. 2016).", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

vepii_cmv_boundary <- st_transform(vepii_cmv_boundary, crs = st_crs(4326)) %>% 
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

tavg_cmv <- brick("./output/paleomat-rasters.tif") %>%
  unstack() %>% 
  purrr::map(., raster::crop, vepii_cmv_boundary)

vepii_nrg_boundary <- st_transform(vepii_nrg_boundary, crs = st_crs(4326)) %>% 
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

tavg_nrg <- brick("./output/paleomat-rasters.tif") %>%
  unstack() %>% 
  purrr::map(., raster::crop, vepii_nrg_boundary)

# Calculate the anomaly across time for CMV (or VEPIIN) (to produce line graph).
anom_cmv <- purrr::map(tavg_cmv, cellStats, mean) %>% 
  as.data.frame() %>% 
  tidyr::pivot_longer(cols = 1:28) %>% 
  dplyr::mutate(name = seq(-950, 1750, 100)) %>% 
  dplyr::rename(year = name, anom = value) %>% 
  dplyr::mutate(Series = "VEPIIN")
  
# anom_cmv <- anom_cmv %>%
#   dplyr::mutate(updated = (anom - mean(anom_cmv$anom)) / sd(anom_cmv$anom)) %>% 
#   dplyr::mutate(series = "CMV")

# Calculate the anomaly across time for NRP (or VEPIIS) (to produce line graph).
anom_nrg <- purrr::map(tavg_nrg, cellStats, mean) %>% 
  as.data.frame() %>% 
  tidyr::pivot_longer(cols = 1:28) %>% 
  dplyr::mutate(name = seq(-950, 1750, 100)) %>% 
  dplyr::rename(year = name, anom = value) %>% 
  dplyr::mutate(Series = "VEPIIS")
  
# anom_nrg <- anom_nrg %>%
#   dplyr::mutate(updated = (anom - mean(anom_nrg$anom)) / sd(anom_nrg$anom)) %>% 
#   dplyr::mutate(series = "NRG")

VEPII <- rbind(anom_cmv, anom_nrg)


# Plot both together
VEPII %>%
  #dplyr::filter(year > 0) %>% 
  ggplot(aes(x = year, y = anom, colour=Series)) +
  geom_line(size = 1.0) +
  xlab("Year BC/AD") +
  ylab("July Temperature Anomaly (°C)") +
  scale_x_continuous(breaks = seq(-1000, 1800, 200),
                     minor_breaks = seq((-1000 + 100), (1800 - 100), 200)) +
  scale_y_continuous(breaks = seq(-2.5, 1.0, 0.5),
                     limits = c(-2.5, 1.0)) +
  theme_bw() +
  # annotate(
  #   "rect",
  #   xmin = 800,
  #   xmax = 1200,
  #   ymin = -2.5,
  #   ymax = 0.0,
  #   alpha = .2
  # ) +
  # annotate(
  #   "text",
  #   x = 1000,
  #   y = -0.25,
  #   label = "Medieval Warm \n Period",
  #   size = 4.5
  # ) +
  #   annotate(
  #   "rect",
  #   xmin = 1400,
  #   xmax = 1800,
  #   ymin = -2.5,
  #   ymax = 0.0,
  #   alpha = .2
  # ) +
  # annotate(
  #   "text",
  #   x = 1600,
  #   y = -0.25,
  #   label = "Little Ice \n Age",
  #   size = 4.5
  # ) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 6,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 6,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black")
  )


```

```{r fig8, fig.cap="Comparison of low-frequency reconstruction from this study, crop productivity, and niche.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

years <- 1:1300

paleomat <-
  read.csv(file = "./output/paleomat-temp-anomaly-final.csv", header = TRUE) %>%
  dplyr::filter(year >= 1 & year <= 1250)

paleomat <- paleomat %>% 
  dplyr::mutate(updated = (anom - mean(paleomat$anom)) / sd(paleomat$anom))

# Estimated potential average maize yield (kg) in the CMV region
years_vep <- data.frame(Year = seq(1, 599, 1))
vep_paleoprod_mean <-
  read.csv("./data-raw/vepiin_paleoprod_stats.csv")
vep_paleoprod_mean <-
  dplyr::bind_rows(years_vep, vep_paleoprod_mean)

vep_paleoprod_mean <- vep_paleoprod_mean %>% 
  dplyr::mutate(updated = (`Average.prod..linear.lagged.` - mean(vep_paleoprod_mean$`Average.prod..linear.lagged.`, na.rm = TRUE)) / sd(vep_paleoprod_mean$`Average.prod..linear.lagged.`, na.rm = TRUE))


# Proportion of the CMV region in the maize dry-farming niche
vep_niche_percent <- read.csv("./data-raw/vepiin_niche_stats.csv")

vep_niche_percent <- vep_niche_percent %>% 
  dplyr::mutate(updated = (`Prop.in.niche..linear.lagged.` - mean(vep_niche_percent$`Prop.in.niche..linear.lagged.`, na.rm = TRUE)) / sd(vep_niche_percent$`Prop.in.niche..linear.lagged.`, na.rm = TRUE))


all_reconstructions <- vep_paleoprod_mean %>%
  dplyr::select(Year, `Average.prod..linear.lagged.`) %>%
  dplyr::rename(
    "Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
  ) %>%
  dplyr::left_join(
    vep_niche_percent %>% dplyr::select(Year, `Prop.in.niche..linear.lagged.`) %>% dplyr::rename(
      "Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
    ),
    by = "Year"
  ) %>%
  dplyr::left_join(
    paleomat %>% dplyr::rename(
      "Year" = 1,
      "MAT - Temperature Anomaly °C (100-year Intervals)" = 2
    ) ,
    by = "Year"
  ) %>%
  tidyr::pivot_longer(!Year, "Measure", "value") %>%
  dplyr::filter(!is.na(value))

all_reconstructions$Measure_f = factor(
  all_reconstructions$Measure ,
  levels = c(
    'Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'MAT - Temperature Anomaly °C (100-year Intervals)'
  )
)


ggplot(all_reconstructions, aes(x = Year)) +
  geom_line(aes(y = value)) +
  scale_x_continuous(
    breaks = c(1, seq(100, 1300, 100)),
    limits = c(1, 1300),
    expand = c(0, 0)
  ) +
  ggplot2::xlab("Year AD") +
  ggplot2::ylab("") +
  ggplot2::theme_linedraw() +
  facet_wrap("Measure_f",
             ncol = 1,
             scales = "free_y") +
  guides(fill = FALSE, color = FALSE) +
  theme(text = element_text(size = 15),
        plot.margin = margin(10, 15, 10, 10))






# plot together using the standardized values.
all_reconstructions <- vep_paleoprod_mean %>%
  dplyr::select(Year, updated) %>%
  dplyr::rename(
    "Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
  ) %>%
  dplyr::left_join(
    vep_niche_percent %>% dplyr::select(Year, updated) %>% dplyr::rename(
      "Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
    ),
    by = "Year"
  ) %>%
  dplyr::left_join(
    paleomat %>% dplyr::select(year, updated) %>% 
      dplyr::rename(
      "Year" = 1,
      "MAT - Temperature Anomaly °C (100-year Intervals)" = 2
    ) ,
    by = "Year"
  ) %>%
  tidyr::pivot_longer(!Year, "Measure", "value") %>%
  dplyr::filter(!is.na(value))

all_reconstructions$Measure_f = factor(
  all_reconstructions$Measure ,
  levels = c(
    'Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'MAT - Temperature Anomaly °C (100-year Intervals)'
  )
)

ggplot(all_reconstructions, aes(x = Year, y = value, colour = Measure)) +
  geom_line() +
  scale_x_continuous(
    breaks = c(1, seq(100, 1300, 100)),
    limits = c(1, 1300),
    expand = c(0, 0)
  ) +
  ggplot2::xlab("Year AD") +
  ggplot2::ylab("") +
  theme(legend.position = "none") +
  ggplot2::theme_linedraw() +
  facet_wrap("Measure_f",
             ncol = 1,
             scales = "free_y") +
  guides(fill = FALSE, color = FALSE) +
  theme(text = element_text(size = 15),
        plot.margin = margin(10, 15, 10, 10))


```



# Tables

```{r table1, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='asis'}

fossil.locs2 <-
    readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>% dplyr::filter(month == 7) %>% 
  dplyr::select(-c(month, type, pub_year, value, error, sample.id)) %>% 
  dplyr::ungroup() %>% 
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(dataset.id, site.id, site.name) %>% 
  summarise(minAge = min(age), maxAge = max(age), minDepth = min(depth), maxDepth = max(depth), across(c(long, lat, elev), unique)) %>% 
  dplyr::select(site.name, site.id, dataset.id, minAge, maxAge, minDepth, maxDepth, long, lat, elev) %>% 
  dplyr::arrange(site.name) %>% 
  dplyr::rename("Site Name" = site.name, "Site ID" = site.id, "Dataset ID" = dataset.id, "Earliest date of core (BP)" = minAge, "Latest date of core (BP)" = maxAge, "Minimum Depth" = minDepth, "Maximum Depth" = maxDepth, "Longitude" = long, "Latitude" = lat, "Elevation (m)" = elev )

#write.csv(fossil.locs2, "./vignettes/data/fossil.locations.csv", row.names = FALSE)

knitr::kable(fossil.locs2,
             caption = "Metadata for the fossil pollen records used in this study.")

```
