---
title: "Paleomat Figures"
author: "Andrew Gillreath-Brown"
date: "08/29/2022"
output: bookdown::word_document2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(paleomat)
library(maps)
data(us.cities)
library(ggh4x)

```

# Figures

```{r fig1, fig.cap="Modern pollen samples used in this study from the Neotoma Paleoecological Database.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all', fig.height = 9.83, fig.width = 16.31}

MPCT_climate_final <-
  readr::read_rds(here::here("vignettes/data/MPCT_climate_final.rds"))

usa <-
  sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE)) %>%
  sf::st_transform(., crs = 4326)

ggplot() +
  geom_sf(data = usa, fill = NA) +
  geom_sf(data = MPCT_climate_final,
          inherit.aes = FALSE,
          aes(geometry = geometry)) +
  coord_sf(xlim = c(-125, -95), ylim = c(25, 50)) +
  theme_classic() +
  scale_x_continuous(breaks = seq(-125, -95, 5.0)) +
  scale_y_continuous(breaks = seq(25, 50, 5)) +
  labs(colour = "") +
  theme(
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.text.x = element_text(angle = 90,
                               margin = margin(
                                 t = -25,
                                 r = 10,
                                 b = 10,
                                 l = 10
                               )),
    axis.line = element_blank()
  )

# ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure1.png", dpi = 600)


```



```{r fig2, fig.cap="The Southwest United States (SWUS) as defined here, showing locations of fossil pollen samples used in this study. Background shading indicates mean July temperature for 1961 - 1990 from PRISM (Daly et al., 2008, 2015; PRISM Climate Group, 2019) at 800-m resolution. The solid gray box outlines the area studied by Bocinsky and Kohler (2014); the green dashed box shows the extent of the reconstruction in this study.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all', fig.height = 9.83, fig.width = 16.31}

# Showing extent of UUSS and the fossil pollen sites.

# Get locations of the fossil pollen sites.
fossil.locs <-
  readr::read_rds(here::here(
    "./vignettes/data/fossil_final_west_metadata_post5500BP.rds"
  )) %>%
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>%
  dplyr::select(-geometry) %>%
  dplyr::group_by(site.name) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(site.id, site.name, long, lat)

# Get the PRISM modern July temperature dataset.
temp.raster <-
  raster::raster("./vignettes/data/raw_data/temp.raster.tif")

# Create a bounding box for the upper united states southwest
bb <-
  c(
    "xmin" = -113,
    "xmax" = -105,
    "ymin" = 32,
    "ymax" = 38.09
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

cities2 <- us.cities %>%
  dplyr::select(name, long, lat) %>%
  dplyr::filter(
    name %in% c(
      "Farmington NM",
      "Santa Fe NM",
      "Albuquerque NM",
      "Flagstaff AZ",
      "Phoenix AZ"
    )
  ) %>%
  dplyr::add_row(name = "Mesa Verde CO",
                 long = -108.463050,
                 lat = 37.230299)

cities3 <- cities2
cities3$name <-
  trimws(gsub(
    pattern = "NM|AZ|CO",
    replacement = "",
    cities3$name,
    perl = T
  ))

cities <- cities2  %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

fossil.sites <- fossil.locs %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

crs(temp.raster) <-
  "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
temperature <- as.data.frame(temp.raster, xy = TRUE)
names(temperature) <- c("long", "lat", "tavg")
temperature_transformed <-
  usmap::usmap_transform(
    temperature,
    input_names = c("long", "lat"),
    output_names = c("x", "y")
  )

# Create a bounding box for limits of this study
bb2 <-
  c(
    "xmin" = -112.81446,
    "xmax" = -105.52416,
    "ymin" = 32.65757,
    "ymax" = 38.089
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)


ggplot() +
  geom_raster(
    data = temperature_transformed,
    aes(x = long, y = lat, fill = tavg),
    alpha = 0.8,
    na.rm = TRUE
  ) +
  scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                       #limits = c(-8, 8),
                       na.value = "transparent",
                       name = "Temperature °C") +
  coord_equal() +
  theme_classic() +
  scale_x_continuous(breaks = seq(-115, -103, 2.0),
                     limits = c(-115, -103.2)) +
  scale_y_continuous(breaks = seq(31, 39, 2.0),
                     limits = c(31.25, 39)) +
  geom_sf(
    data = usa,
    color = "#2b2b2b",
    fill = "transparent",
    size = 1.0
  ) +
  geom_sf(
    data = fossil.sites,
    shape = 20,
    fill = "blue",
    size = 3.5
  ) +
  geom_sf(
    data = cities,
    shape = 23,
    fill = "blue",
    size = 3.5
  ) +
  geom_sf(
    data = bb,
    size = 1.5,
    fill = NA,
    aes(colour = "darkgrey",
        linetype = "darkgrey"),
    show.legend = "line",
    inherit.aes = FALSE
  ) +
  geom_sf(
    data = bb2,
    size = 1.5,
    fill = NA,
    aes(colour = "darkolivegreen4",
        linetype = "darkolivegreen4"),
    show.legend = "line",
    inherit.aes = FALSE
  ) +
  scale_color_manual(
    values = c("darkgrey" = "darkgrey", "darkolivegreen4" = "darkolivegreen4"),
    labels = c("Bocinsky and Kohler 2014", "This Study"),
    name = "Data Extent"
  ) +
  scale_linetype_manual(
    values = c("darkgrey" = "solid", "darkolivegreen4" = "dashed"),
    labels = c("Bocinsky and Kohler 2014", "This Study"),
    name = "Data Extent"
  ) +
  shadowtext::geom_shadowtext(
    data = cities3,
    aes(x = long, y = lat, label = name),
    nudge_y = 0.265,
    color = "white",
    size = 4
  ) +
  labs(colour = "") +
  annotate(
    "text",
    x = -109.75,
    y = 38.5,
    label = "UTAH",
    size = 6,
    fontface = 2,
    hjust = 1.0
  ) +
  annotate(
    "text",
    x = -108.25,
    y = 38.5,
    label = "COLORADO",
    size = 6,
    fontface = 2,
    hjust = 0
  ) +
  annotate(
    "text",
    x = -109.75,
    y = 32.3,
    label = "ARIZONA",
    size = 6,
    fontface = 2,
    hjust = 1
  ) +
  annotate(
    "text",
    x = -108.25,
    y = 32.3,
    label = "NEW MEXICO",
    size = 6,
    fontface = 2,
    hjust = 0
  ) +
  theme(
    legend.key.width = unit(1.25, 'cm'),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.text.x = element_text(angle = 90),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 18, family = "Helvetica"),
    legend.title = element_text(size = 19, family = "Helvetica")
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure2b.png", dpi = 600)


```


```{r fig3, fig.cap= "Temperature for the North Atlantic using Richard Alley’s (2000) Greenland ice core data for 18,000 BC to present with the Younger Dryas and the general period of the northward expansion of maize agriculture from Mesoamerica into the SWUS highlighted.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}
# Greenland ice core data (used in Huckleberry 2015) from Alley 2000.

alley2000 <-
  read.csv(file = "data-raw/gisp2_temp_accum_alley2000.csv", header = TRUE) %>%
  dplyr::mutate(Age = Age * 1000)  %>%
  dplyr::filter(Age <= 20000) %>% 
  dplyr::mutate(Age = BPtoBCAD(Age))

alley2000 %>%
  ggplot(aes(x = Age, y = Temperature)) +
  geom_line(size = 2) +
  scale_x_continuous(breaks = seq(-18000, 2000, 2000),
                     limits = c(-18000, 2000),
                     minor_breaks=seq(-17000, 2000,by=1000),
                     guide = "axis_minor") +
  scale_y_continuous(breaks = seq(-50, -28, 2),
                     minor_breaks=seq(-49, -29,by=1),
                     guide = "axis_minor") +
  theme_classic() +
  xlab("Years BC/AD") +
  ylab("Temperature °C") +
  annotate(
    "rect",
    xmin = -10851 ,
    xmax = -9551,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = -10201,
    y = -27.25,
    label = "Younger \n Dryas",
    size = 8
  ) +
  geom_segment(aes(
    x = -6251,
    y = -36.5,
    xend = -6251,
    yend = -33
  ),
  arrow = arrow(length = unit(0.3, "cm"))) +
  annotate(
    "text",
    x = -6251,
    y = -38,
    label = "6250 BC \n Cold Event",
    size = 8
  ) +
  annotate(
    "rect",
    xmin = -2051,
    xmax = -4051,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = -3051,
    y = -27.25,
    label = "Northward Expansion \n of Agriculture",
    size = 8
  ) +
    theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure3.png", dpi = 600)


```


```{r fig4, fig.cap="Low-frequency component of the Moberg et al. (2005) multi-proxy reconstruction for Northern Hemisphere for AD 133–1925. Anomaly is calculated in comparison to the 1961–1990 average.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Moberg et al. 2005 low-frequency reconstruction (only).
Moberg <-
  read.delim(
    "./data-raw/nhtemp-moberg2005.txt",
    header = TRUE,
    sep = "\t",
    dec = "."
  ) [, 1:3] %>%
  dplyr::filter(LF > -9.89 & date <= 2000)

ggplot(data = Moberg, aes(x = date, y = LF)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years AD") +
  ylab("Temperature Anomaly (°C)") +
  scale_x_continuous(breaks=seq(0,2000,200),
                     minor_breaks=seq(100, 1900,by=200),
                     guide = "axis_minor") +
  scale_y_continuous(breaks = seq(-0.7, 0, 0.1), 
                     limits = c(-0.7, 0),
                     minor_breaks=seq(-0.65, -0.05,by=0.05),
                     guide = "axis_minor") +
  theme_bw() +
  geom_hline(yintercept = 0, color = "darkgrey", lty = 2, lwd=1.25) +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure4.png", dpi = 600)

```


```{r fig5, fig.cap="Low-frequency bootstrapped temperature anomaly loess reconstruction from this study (blue) with standard error (gray). Boxplots show estimates binned by century. Anomalies are calculated in comparison to the 1961–1990 average. The temperature predictions for each sample (not binned by century) are shown by circles; sizes of circles are inversely proportional to the sample-specific errors (size of circle ∝ 1/s1; see Simpson, 2007: 21 for calculation of s1). Anomaly estimates with larger circles are more precise.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

Threebest <- readr::read_rds(here::here("vignettes/data/final_paleomat_dataset3.rds")) %>%
  filter(date >= -3000)

Threebest$century <- round(as.numeric(Threebest$date),-2)

weight <- (1 / Threebest$s1)

Threebest %>%
  ggplot(aes(y = anom_bootstrap)) +
  geom_boxplot(
    aes(x = century, group = century),
    lwd = .25,
    outlier.alpha = NA,
    outlier.shape = NA,
    position = position_dodge2(preserve = "total")
  ) +
  geom_point(aes(x = date), size=weight, shape=1) +
  geom_hline(yintercept = 0,
             linetype = 'dashed',
             color = c('darkslategray')) +
  geom_smooth(method = "loess", span = 0.15, aes(x = date), size = 2, colour = "cornflowerblue") +
  scale_x_continuous(limits = c(-3000, 2100),
                     breaks = seq(-3000, 2000, 500),
                     minor_breaks=seq(-2900, 2000,by=100),
                     guide = "axis_minor") +
  scale_y_continuous(limits = c(-8, 8),
                     breaks = seq(-8, 8, 2),
                     minor_breaks=seq(-7, 7,by=1),
                     guide = "axis_minor") +
  theme_bw() +
  xlab("Years BC/AD") +
  ylab("Temperature Anomaly (°C)") +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure5b.png", dpi = 600)

```

```{r fig6, fig.cap="Low-frequency July temperature anomaly for the SWUS from this study, the North American July temperature reconstruction (Viau et al., 2006) from 3000 BC to AD 2000, and the terrestrial composite for 30–60 °N (Kaufman et al., 2020), from 3300 BC to AD 1700, in 500-year bins. All series standardized to a mean of 0 and an s of 1 over the period in this graph.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all', fig.height = 9.83, fig.width = 16.31}

#scaleFUN <- function(x) sprintf("%.2f", x)

# For our reconstruction, we first extract the fitted values from the loess line, as plotting above.
p <- Threebest %>%
  filter(date >= -3000) %>%
  qplot(date, anom_bootstrap, data = .) +
  stat_smooth(aes(outfit = fit <<- ..y..), span = 0.15, n = 5000)

anom_loess4 <- ggplot_build(p)$data[[2]]

viau <- read.csv("./data-raw/viau.csv") %>% 
  dplyr::mutate(time = BPtoBCAD(time))

kaufman_standard <- read.csv("./data-raw/Kaufman 2020_Figure6Data.csv") %>% 
  dplyr::mutate(time = BPtoBCAD(time_bp),
                Series = "Kaufman et al. 2020") %>% 
  dplyr::select(year = time, anom = zscore, Series) %>% 
  dplyr::filter(year > -3400)

temp_anom_standard <- anom_loess4 %>% 
  dplyr::mutate(x = as.integer(x)) %>% 
  dplyr::filter(x >= -3000 & x <= 1951) %>% 
  dplyr::mutate(Series = "This study") %>% 
  dplyr::select(year = x, anom = y, Series)

viau_standard <- viau %>% 
  dplyr::mutate(Series = "Viau et al. 2006") %>% 
  dplyr::select(year = time, anom = temp, Series) %>% 
  filter(year >= -3000 & year <= 1951)

viau_paleomat_kaufman <- bind_rows(temp_anom_standard, viau_standard, kaufman_standard)

viau_paleomat_kaufman$Series <- factor(viau_paleomat_kaufman$Series, c("Viau et al. 2006", "Kaufman et al. 2020", "This study"))

# Viau and paleomat
viau_paleomat_kaufman %>% 
  mutate(Alpha = case_when(Series == "This study" ~ 1,
                           TRUE ~ 0.65)) %>% 
  group_by(Series) %>% 
  dplyr::mutate(update = (anom - mean(anom)) / sd(anom)) %>% 
  ggplot(aes(x = year, y = update, colour = Series, alpha = Alpha)) +
  geom_hline(yintercept = 0, color = "darkgrey", lty = 2, lwd = 1.25) +
  geom_line(aes(size = Series)) +
  scale_size_manual(values = c(0.75, 0.75, 2)) +
  scale_alpha_identity() +
  scale_color_manual(values=c("darkolivegreen", "#D55E00", "cornflowerblue")) +
  scale_x_continuous(
                     breaks = seq(-3500, 2000, 500), 
                     minor_breaks=seq(-3400,1900,by=100),
                     guide = "axis_minor") +
  scale_y_continuous(breaks = seq(-2, 3.5, 0.5)) +
  xlab("Years BC/AD") +
  ylab("Standardized Temperature Values (Z-Scores)") +
  theme_bw() +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    ),
    legend.text = element_text(size = 19, family = "Helvetica"),
    legend.title = element_blank()
  )


#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure6.png", dpi = 600)


```


```{r fig7, fig.cap="Low-frequency July temperature anomaly for the SWUS from this study and the Northern Hemisphere low-frequency component (Moberg et al. 2005) from AD 133 to 1900. Both series have been standardized to a mean of 0 and an s of 1 for this period.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

temp_anom_standard <- anom_loess4 %>% 
  dplyr::mutate(x = as.integer(x)) %>% 
  dplyr::filter(x >= 133 & x <= 1900) %>% 
  dplyr::mutate(Series = "This study") %>% 
  dplyr::select(year = x, anom = y, Series)

Moberg_standard <- Moberg %>% 
  dplyr::mutate(Series = "Moberg et al. 2005") %>% 
  dplyr::select(year = date, anom = LF, Series) %>% 
  filter(year >= 133 & year <= 1900)

Moberg_paleomat <- bind_rows(temp_anom_standard, Moberg_standard)

# Moberg LF and paleomat
Moberg_paleomat %>% 
  group_by(Series) %>% 
  dplyr::mutate(update = (anom - mean(anom)) / sd(anom)) %>% 
  ggplot(aes(x = year, y = update, colour = Series)) +
  geom_hline(yintercept = 0, color = "darkgrey", lty = 2, lwd = 1.25) +
  geom_line(size = 2.0) +
  scale_color_manual(values=c("#A60F2D", "cornflowerblue")) +
  xlab("Years AD") +
  ylab("Standardized Temperature Values (Z-Scores)") +
  scale_x_continuous(limits = c(100, 1900),
                     breaks = seq(100, 1900, 200), 
                     minor_breaks=seq(200,1800,by=200),
                     guide = "axis_minor") +
  scale_y_continuous(breaks = seq(-2, 3, 0.5)) +
  theme_bw() +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    ),
    legend.text = element_text(size = 19, family = "Helvetica"),
    legend.title = element_blank()
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/Figure7.png", dpi = 600)


```


# Tables

```{r table1, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='asis'}

# Pulling together information for Table 1, except for references, which are done elsewhere.

fossil_metadata_counts_final2 <-
  readr::read_rds(here::here("vignettes/data/fossil_metadata_counts_final2.rds"))

sig_pass <-
  readr::read_rds(here::here("vignettes/data/sig_results2_final.rds")) %>%
  mutate(pass = ifelse(pvalue <= 0.10, "Yes", "No")) %>%
  dplyr::select(dataset.id, pass)

table1 <-
  fossil_metadata_counts_final2 %>%
  filter(age <= 5500) %>%
  dplyr::select(site.name, site.id, dataset.id, elev) %>%
  group_by(site.name, site.id, dataset.id, elev) %>%
  count() %>%
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>%
  dplyr::select(-geometry) %>%
  dplyr::arrange(site.name) %>%
  dplyr::left_join(., sig_pass, by = "dataset.id") %>%
  dplyr::mutate(pass = ifelse(is.na(pass), "NA (removed in a previous step)", pass)) %>%
  dplyr::select(
    "Site Name" = site.name,
    "Site ID" = site.id,
    "Dataset ID" = dataset.id,
    "No. of Samples" = n,
    "Elevation (m)" = elev,
    "Longitude" = long,
    "Latitude" = lat,
    "Pass significance test?" = pass
  )

knitr::kable(table1,
             caption = "Metadata for the fossil pollen records (37 sites or 41 datasets) used in this study that have data after 3,550 BC. All data were downloaded from the Neotoma Paleoecological Database (Williams et al., 2018).")

```

# Supplemental Materials

## Supplemental Tables

```{r supptable1, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='asis'}

fossil_final_west_metadata_post5500BP <-
  readr::read_rds(here::here("vignettes/data/fossil_final_west_metadata_post5500BP.rds")) %>%
  ungroup %>%
  dplyr::select(site.name, site.id, dataset.id) %>% 
  filter(dataset.id %in% c(250L, 347L, 498L, 517L, 1013L, 1162L, 1660L, 1717L, 1761L, 
      1762L, 1766L, 1970L, 2320L, 2880L, 2897L, 2950L, 3054L, 3056L, 
      3060L, 3560L, 3561L, 3608L, 3612L, 14517L, 14547L, 14549L, 14650L, 
      14944L, 14951L, 15106L, 15356L, 15967L, 17419L, 20304L, 20833L, 
      20838L, 22948L, 25551L, 41580L, 42645L, 46801L)) %>% 
  distinct() %>%
  sf::st_drop_geometry()

Threebest <-
  readr::read_rds(here::here("vignettes/data/final_paleomat_dataset3.rds")) %>%
  filter(date >= -3000)

summary_table <- Threebest %>%
  group_by(dataset.id) %>%
  summarise(
    anom_range = max(anom) - min(anom),
    anom_bootstrap_range = max(anom_bootstrap) - min(anom_bootstrap),
    rmsep_mean = mean(rmsep),
    s1_mean = mean(s1)
  )

summary_table_final <-
  readr::read_rds(here::here("vignettes/data/sig_results2_final.rds")) %>%
  left_join(.,
            fossil_final_west_metadata_post5500BP,
            by = "dataset.id") %>%
  dplyr::select(site.name, site.id, dataset.id, proportion, pvalue) %>%
  left_join(., summary_table, by = "dataset.id") %>%
  mutate(a = ifelse(!is.na(anom_range), 1, 2)) %>%
  arrange(a, site.name) %>%
  dplyr::select(-a) %>%
  filter(!is.na(site.name)) %>%
  mutate(across(c(proportion, pvalue), ~ as.numeric(.x))) %>%
  mutate(across(-c(site.name, site.id, dataset.id), ~ round(.x, digits =
                                                              2)))

names(summary_table_final) <-
  c(
    "Site Name",
    "Site ID",
    "Dataset ID",
    "Proportion explained variance",
    "Random TF p",
    "Anomaly (°C)",
    "Anomaly Bootstrapped (°C)",
    "Mean boostrap RMSEP (°C)",
    "Mean boostrap s1"
  )

if (!file.exists(here::here("./vignettes/data/summary_table_final.csv"))) {
  write.csv(summary_table_final,
            "./vignettes/data/summary_table_final.csv",
            row.names = FALSE)
}

knitr::kable(summary_table_final,
             caption = "Metadata for the fossil pollen records used in this study.")


```


# Supplemental Figures

```{r suppfig1, fig.cap="Squared residual length for the fossil assemblages vs age. Red line marks the 95% limit of the calibration set residual lengths (very poorly fitted). We removed all samples that fell above the 95% line.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

ff <- readr::read_rds(here::here("./vignettes/data/fossil_final_west_metadata_post5500BP.rds")) %>% 
  filter(!is.na(age) & age <= 5500) %>% 
  dplyr::select(sample.id, age) %>% 
  mutate(age = BPtoBCAD(age)) %>% 
  sf::st_drop_geometry()


rlen_results_filtered <- readr::read_rds(here::here("./vignettes/data/rlen_full_results2.rds"))$res_lengths %>% 
  left_join(., ff, by = "sample.id")

ninety5quant <- readr::read_rds(here::here("./vignettes/data/rlen_full_results2.rds"))$quantile_95

ggplot(data = rlen_results_filtered, aes(x = age, y = Squared_res_lengths)) +
  geom_point() +
  xlab("Years BC/AD") +
  ylab("Squared Residual Length") +
  scale_x_continuous(limits = c(-3500, 2100),
                     breaks = seq(-3500, 2000, 500),
                     minor_breaks=seq(-3400, 1900,by = 100),
                     guide = "axis_minor") +
  scale_y_continuous(limits = c(0, 260),
                     breaks = seq(0, 260, 20),
                     minor_breaks=seq(10, 240, 10),
                     guide = "axis_minor") +
  theme_bw() +
  geom_hline(yintercept = ninety5quant, color = "red", lty = 1, lwd=0.5) +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/SuppFigure1.png", dpi = 600)


```


```{r suppfig2, fig.cap="Summary diagram of the results of a MAT model applied to predict temperature from the modern pollen data set. The leave-one-out error measure (RMSEP) shows that 4 analogs provide the optimal choice (lowest RMSEP).", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

mat_calibration <- readr::read_rds(here::here("./vignettes/data/mat_calibration.rds"))

tbl <- cbind(mat_calibration$standard$rmsep[1:20], mat_calibration$standard$r.squared[1:20],
             mat_calibration$standard$avg.bias[1:20], mat_calibration$standard$max.bias[1:20])

tbl <- as.matrix(format(tbl, digits = 3))

tbl <- cbind(as.integer(1:20), tbl)

rownames(tbl) <- rep("", nrow(tbl))
colnames(tbl) <- c("k", "RMSEP","R2","Avg Bias","Max Bias")

as.data.frame(tbl) %>% 
  mutate(across(everything(), ~ as.numeric(.x))) %>% 
  ggplot(aes(x = k, y = RMSEP)) +
  geom_line(size = 1) +
  geom_label(aes(label = k), fill = "white", label.size = NA, size = 5.5) +
  xlab("Number of Analogues (k)") +
  ylab("RMSEP") +
  scale_x_continuous(breaks=seq(0,20,2),
                     minor_breaks=seq(1, 19,by=1),
                     guide = "axis_minor") +
  scale_y_continuous(breaks = seq(2.10, 2.45, 0.05), 
                     limits = c(2.10, 2.45),
                     minor_breaks=seq(2.11, 2.44,by=0.01),
                     guide = "axis_minor") +
  theme_bw() +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/SuppFigure2.png", dpi = 600)

```

```{r suppfig3, fig.cap="Time series plot of the minimum dissimilarity between each core (fossil) sample and the modern pollen training set samples. The dotted, horizontal lines are drawn at various percentiles of the distribution of the pair-wise dissimilarities for the training set samples. We used the 5th percentile as the cutoff for good analogs. So, samples with distances greater than the 5th percentile (above the line) were removed.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

minDC_df <- readr::read_rds(here::here("./vignettes/data/minDC_full_results.rds"))$minDC %>% 
  arrange(age)

# Keeping only 1%, 2.5%, and 5%, as I don't want to plot 10%.
minDC_quantiles <- readr::read_rds(here::here("./vignettes/data/minDC_full_results.rds"))$quantiles[1:3]

ggplot(data = minDC_df, aes(x = age, y = values)) +
  xlab("Years BC/AD") +
  ylab("Dissimilarity") +
  scale_x_continuous(limits = c(-3500, 2100),
                     breaks = seq(-3500, 2000, 500),
                     minor_breaks=seq(-3400, 1900,by = 100),
                     guide = "axis_minor") +
  scale_y_continuous(limits = c(0, 0.35),
                     breaks = seq(0, 0.35, 0.05)) +
  theme_bw() +
  annotate("label", x = Inf, y = c(0.1139258, 0.1650981, 0.2171289), label = c("1%", "2.5%", "5%"), hjust = 0, size = 8, fill = "white", label.size = NA) +
  coord_cartesian(xlim = c(-3500, 2000), clip = "off") +
  geom_hline(yintercept = minDC_quantiles, color = "red", lty = "dashed", lwd=0.5) +
  geom_point() +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 75,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/SuppFigure3.png", dpi = 600)


```


```{r suppfig4, fig.cap="Linear regression and scatterplot between temperature anomaly predicted values and the bootstrapped temperature predictions. There is a strong linear relationship across their joint ranges (r2 = 0.96; p > F < .001).", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

Threebest <- readr::read_rds(here::here("vignettes/data/final_paleomat_dataset3.rds")) %>%
  filter(date >= -3000)

Threebest %>%
  ggplot(aes(x = anom, y = anom_bootstrap)) +
    geom_point() +
  stat_smooth(method = "lm", col = "red") +
  scale_x_continuous(limits = c(-9, 9),
                     breaks = seq(-9, 9, 2),
                     minor_breaks=seq(-8, 8,by=1),
                     guide = "axis_minor") +
  scale_y_continuous(limits = c(-9, 9),
                     breaks = seq(-9, 9, 2),
                     minor_breaks=seq(-8, 8,by=1),
                     guide = "axis_minor") +  
  theme_bw() +
  xlab("Temperature Anomaly Predicted Values") +
  ylab("Bootstrapped Temperature Predictions") +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/SuppFigure4.png", dpi = 600)


```



```{r suppfig5, fig.cap="Low-frequency weighted bootstrapped temperature anomaly loess reconstruction from this study (blue) with standard error (gray). As in Figure 5 (main text) except here the loess curve (only) is weighted by the inverse of the sample-specific errors s1; see Simpson, 2007: 21 for calculation). Bubble size α 1/s1.", fig.height = 9.83, fig.width = 16.31, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

Threebest <- readr::read_rds(here::here("vignettes/data/final_paleomat_dataset3.rds")) %>%
  filter(date >= -3000)

Threebest$century <- round(as.numeric(Threebest$date),-2)

weight <- (1 / Threebest$s1)

Threebest %>%
  ggplot(aes(y = anom_bootstrap)) +
  geom_point(aes(x = date), size=weight, shape=1) +
  geom_boxplot(
    aes(x = century, group = century),
    lwd = .25,
    outlier.alpha = NA,
    outlier.shape = NA,
    position = position_dodge2(preserve = "total")
  ) +
  geom_hline(yintercept = 0,
             linetype = 'dashed',
             color = c('darkslategray')) +
  geom_smooth(method = "loess", span = 0.15, aes(x = date, weight = weight), size = 2, colour = "cornflowerblue") +
  scale_x_continuous(limits = c(-3000, 2100),
                     breaks = seq(-3000, 2000, 500),
                     minor_breaks=seq(-2900, 2000,by=100),
                     guide = "axis_minor") +
  scale_y_continuous(limits = c(-8, 8),
                     breaks = seq(-8, 8, 2),
                     minor_breaks=seq(-7, 7,by=1),
                     guide = "axis_minor") +
  theme_bw() +
  xlab("Years BC/AD") +
  ylab("Temperature Anomaly (°C)") +
  theme(
    axis.ticks.length=unit(0.125,"inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

#ggsave("~/Dropbox/WSU/SKOPEII/model/Final_Figures/SuppFigure5.png", dpi = 600)


```
