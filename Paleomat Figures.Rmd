---
title: "Paleomat Figures"
author: "Andrew Gillreath-Brown"
date: "10/20/2021"
output: bookdown::word_document2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(paleomat)
library(maps)
data(us.cities)

```

```{r fig1, fig.cap= "Temperature for the North Atlantic using Greenland ice core data (Alley 2000) for 20,000 BP to present.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}
# Greenland ice core data (used in Huckleberry 2015) from Alley 2000.

alley2000 <-
  read.csv(file = "data-raw/gisp2_temp_accum_alley2000.csv", header = TRUE) %>%
  dplyr::mutate(Age = Age * 1000)  %>%
  dplyr::filter(Age <= 20000)

alley2000 %>%
  ggplot(aes(x = Age, y = Temperature)) +
  geom_line() +
  scale_x_reverse(breaks = seq(0, 20000, 2500)) +
  theme_classic() +
  xlab("calibrated years BP") +
  ylab("Temperature °C") +
  annotate(
    "rect",
    xmin = 11500,
    xmax = 12800,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 12150,
    y = -27.25,
    label = "Younger \n Dryas",
    size = 3.5
  ) +
  geom_segment(aes(
    x = 8200,
    y = -36.5,
    xend = 8200,
    yend = -33
  ),
  arrow = arrow(length = unit(0.3, "cm"))) +
  annotate(
    "text",
    x = 8200,
    y = -38,
    label = "8200 cal yr BP \n cold event",
    size = 3
  ) +
  annotate(
    "rect",
    xmin = 4000,
    xmax = 6000,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 5000,
    y = -27.25,
    label = "northward expansion \n of agriculture",
    size = 3
  ) 

# Warmest periods following 5000 BP.
# 3297.07     -28.748
# 2068.24    -29.5708
# 1514.860    -30.4060
# 964.939    -30.4628

```


```{r fig2, fig.cap="Low-frequency component of Moberg et al. (2005) multi-proxy reconstruction for Northern Hemisphere for 1817-25 BP.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Moberg et al. 2005 low-frequency reconstruction (only).
Moberg <-
  read.delim(
    "./data-raw/nhtemp-moberg2005.txt",
    header = TRUE,
    sep = "\t",
    dec = "."
  ) [, 1:3] %>%
  dplyr::filter(LF != -9.9999 & date <= 2000) %>%
  dplyr::mutate(date = 1950 - date)


ggplot(data = Moberg, aes(x = date, y = LF)) +
  geom_line(size = 1.5) +
  xlab("calibrated years BP") +
  ylab("Temperature Anomaly (°C)") +
  #scale_x_continuous(breaks=seq(0,2000,200), minor_breaks = seq(100, 1900, 200)) +
  scale_x_reverse(breaks = seq(0, 2000, 200),
                  minor_breaks = seq(100, 1900, 200)) +
  scale_y_continuous(breaks = seq(-0.8, 0, 0.1), limits = c(-0.8, 0)) +
  theme_bw() +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "grey 70"),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 10,
      b = 5,
      l = 5
    )
  )
```

```{r fig3, fig.cap="Locations of fossil pollen samples used in this study and extent of the Upper United States Southwest (Bocinsky and Kohler 2014).", fig.width=6.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Showing extent of UUSS and the fossil pollen sites.

# Get locations of the fossil pollen sites.
fossil.locs <-
  readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>%
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(site.name) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(site.id, site.name, long, lat)

# Get the PRISM modern July temperature dataset.
modern_temp <-
  brick(
    "/Volumes/PUCK_HD/Users/andrew/Dropbox/WSU/SKOPEII/Figures/PRISM_tavg_monthly_normals.tif"
  ) %>%
  raster::subset(7)

temp.raster <-
  raster::projectRaster(modern_temp, crs = CRS("+init=epsg:4326"))

# bbox_buffer <- c(
#   "xmin" = min(fossil.locs$long) - 1,
#   "ymin" = min(fossil.locs$lat) - 1,
#   "xmax" = max(fossil.locs$long) + 1,
#   "ymax" = max(fossil.locs$lat) + 1
# )  %>%
#   sf::st_bbox() %>%
#   sf::st_as_sfc() %>%
#   sf::st_as_sf(crs = 4326) %>%
#   sf::st_transform(crs = 4326)
#
# temp.raster.cropped <- raster::crop(temp.raster, bbox_buffer)

# Create a bounding box for the upper united states southwest
bb <-
  c(
    "xmin" = -113,
    "xmax" = -105,
    "ymin" = 32,
    "ymax" = 38.09
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

usa <- sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
usa <- sf::st_transform(usa, crs = 4326)

cities2 <- us.cities %>%
  dplyr::select(name, long, lat) %>%
  dplyr::filter(
    name %in% c(
      "Farmington NM",
      "Santa Fe NM",
      "Albuquerque NM",
      "Flagstaff AZ",
      "Phoenix AZ"
    )
  ) %>%
  dplyr::add_row(name = "Mesa Verde CO",
                 long = -108.463050,
                 lat = 37.230299)

cities <- cities2  %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

fossil.sites <- fossil.locs %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

crs(temp.raster) <-
  "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
temperature <- as.data.frame(temp.raster, xy = TRUE)
temperature_transformed <- usmap::usmap_transform(temperature)


ggplot() +
  geom_raster(
    data = temperature_transformed,
    aes(x = x, y = y, fill = PRISM_tavg_monthly_normals.7),
    alpha = 0.8,
    na.rm = TRUE
  ) +
  scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                       #limits = c(-8, 8),
                       na.value = "transparent",
                       name = "Temperature °C") +
  coord_equal() +
  theme_classic() +
  scale_x_continuous(breaks = seq(-115,-103, 2.0),
                     limits = c(-115,-103.2)) +
  scale_y_continuous(breaks = seq(31, 39, 2.0),
                     limits = c(31.25, 39)) +
  geom_sf(
    data = usa,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.5
  ) +
  geom_sf(
    data = fossil.sites,
    shape = 20,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = cities,
    shape = 23,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = bb,
    size = 1,
    fill = NA,
    colour = "dark grey",
    alpha = 0.3
  ) +
  shadowtext::geom_shadowtext(
    data = cities2,
    aes(x = long, y = lat, label = name),
    nudge_y = 0.265,
    color = "white",
    size = 2.5
  ) +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 10,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black"),
    legend.text = element_text(size = 10, family = "Helvetica"),
    legend.title = element_text(size = 11, family = "Helvetica")
  )



```


```{r table1, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='asis'}

fossil.locs2 <-
    readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>% dplyr::filter(month == 7) %>% 
  dplyr::select(-c(month, type, pub_year, value, error, sample.id)) %>% 
  dplyr::ungroup() %>% 
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(dataset.id, site.id, site.name) %>% 
  summarise(minAge = min(age), maxAge = max(age), minDepth = min(depth), maxDepth = max(depth), across(c(long, lat, elev), unique)) %>% 
  dplyr::select(site.name, site.id, dataset.id, minAge, maxAge, minDepth, maxDepth, long, lat, elev) %>% 
  dplyr::arrange(site.name) %>% 
  dplyr::rename("Site Name" = site.name, "Site ID" = site.id, "Dataset ID" = dataset.id, "Earliest date of core (BP)" = minAge, "Latest date of core (BP)" = maxAge, "Minimum Depth" = minDepth, "Maximum Depth" = maxDepth, "Longitude" = long, "Latitude" = lat, "Elevation (m)" = elev )

#write.csv(fossil.locs2, "./vignettes/data/fossil.locations.csv", row.names = FALSE)

knitr::kable(fossil.locs2,
             caption = "Metadata for the fossil pollen records used in this study.")

```
