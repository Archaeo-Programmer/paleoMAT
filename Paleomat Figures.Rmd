---
title: "Paleomat Figures"
author: "Andrew Gillreath-Brown"
date: "10/20/2021"
output: bookdown::word_document2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(paleomat)
library(maps)
data(us.cities)

```

# Figures

```{r fig1, fig.cap="Locations of fossil pollen samples used in this study over the mean July temperature for 1961 to 1990 from PRISM at 800-m resolution. The grey box indicates the extent of the Upper United States Southwest (Bocinsky and Kohler 2014), and the red box shows the extent of the reconstruction in this study.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Showing extent of UUSS and the fossil pollen sites.

# Get locations of the fossil pollen sites.
fossil.locs <-
  readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>%
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(site.name) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(site.id, site.name, long, lat)

# Get the PRISM modern July temperature dataset.
modern_temp <-
  brick(
    "/Volumes/PUCK_HD/Users/andrew/Dropbox/WSU/SKOPEII/Figures/PRISM_tavg_monthly_normals.tif"
  ) %>%
  raster::subset(7)

temp.raster <-
  raster::projectRaster(modern_temp, crs = CRS("+init=epsg:4326"))

# bbox_buffer <- c(
#   "xmin" = min(fossil.locs$long) - 1,
#   "ymin" = min(fossil.locs$lat) - 1,
#   "xmax" = max(fossil.locs$long) + 1,
#   "ymax" = max(fossil.locs$lat) + 1
# )  %>%
#   sf::st_bbox() %>%
#   sf::st_as_sfc() %>%
#   sf::st_as_sf(crs = 4326) %>%
#   sf::st_transform(crs = 4326)
#
# temp.raster.cropped <- raster::crop(temp.raster, bbox_buffer)

# Create a bounding box for the upper united states southwest
bb <-
  c(
    "xmin" = -113,
    "xmax" = -105,
    "ymin" = 32,
    "ymax" = 38.09
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

usa <- sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
usa <- sf::st_transform(usa, crs = 4326)

cities2 <- us.cities %>%
  dplyr::select(name, long, lat) %>%
  dplyr::filter(
    name %in% c(
      "Farmington NM",
      "Santa Fe NM",
      "Albuquerque NM",
      "Flagstaff AZ",
      "Phoenix AZ"
    )
  ) %>%
  dplyr::add_row(name = "Mesa Verde CO",
                 long = -108.463050,
                 lat = 37.230299)

cities3 <- cities2
cities3$name <- trimws(gsub(pattern = "NM|AZ|CO",replacement = "", cities3$name, perl = T))

cities <- cities2  %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

fossil.sites <- fossil.locs %>%
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326)

crs(temp.raster) <-
  "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
temperature <- as.data.frame(temp.raster, xy = TRUE)
temperature_transformed <- usmap::usmap_transform(temperature)

# Create a bounding box for limits of this study
bb2 <-
  c(
    "xmin" = -112.81446,
    "xmax" = -105.52416,
    "ymin" = 32.65757,
    "ymax" = 38.089
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)


ggplot() +
  geom_raster(
    data = temperature_transformed,
    aes(x = x, y = y, fill = PRISM_tavg_monthly_normals.7),
    alpha = 0.8,
    na.rm = TRUE
  ) +
  scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                       #limits = c(-8, 8),
                       na.value = "transparent",
                       name = "Temperature °C") +
  coord_equal() +
  theme_classic() +
  scale_x_continuous(breaks = seq(-115,-103, 2.0),
                     limits = c(-115,-103.2)) +
  scale_y_continuous(breaks = seq(31, 39, 2.0),
                     limits = c(31.25, 39)) +
  geom_sf(
    data = usa,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.5
  ) +
  geom_sf(
    data = fossil.sites,
    shape = 20,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = cities,
    shape = 23,
    fill = "blue",
    size = 3
  ) +
  geom_sf(
    data = bb,
    size = 1,
    fill = NA,
    aes(colour = "darkgrey"),
    alpha = 0.3,
    show.legend = "line"
  ) +
  geom_sf(
    data = bb2,
    size = 1,
    fill = NA,
    aes(colour = "red2"),
    alpha = 0.3,
    show.legend = "line"
  ) +
    scale_color_manual(values = c("red2" = "red2", "darkgrey" = "darkgrey"), 
                       labels = c("This Study", "Bocinsky and Kohler 2014"),
                       name = "Data Extent") +
  shadowtext::geom_shadowtext(
    data = cities3,
    aes(x = long, y = lat, label = name),
    nudge_y = 0.265,
    color = "white",
    size = 2.5
  ) +
  xlab("Longitude") +
  ylab("Latitude") +
  labs(colour = "") 
  annotate("text", x=-109.75, y=37.25, label= "UTAH", size = 5, fontface = 2, hjust = 1) +
  annotate("text", x=-108.25, y=37.25, label= "COLORADO", size = 5, fontface = 2, hjust = 0) +
  annotate("text", x=-109.75, y=36.5, label= "ARIZONA", size = 5, fontface = 2, hjust = 1) +
  annotate("text", x=-108.25, y=36.5, label= "NEW MEXICO", size = 5, fontface = 2, hjust = 0) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 10,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 12,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black"),
    legend.text = element_text(size = 10, family = "Helvetica"),
    legend.title = element_text(size = 11, family = "Helvetica")
  )



```


```{r fig2, fig.cap= "Temperature for the North Atlantic using Greenland ice core data (Alley 2000) for 20,000 BP to present.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}
# Greenland ice core data (used in Huckleberry 2015) from Alley 2000.

alley2000 <-
  read.csv(file = "data-raw/gisp2_temp_accum_alley2000.csv", header = TRUE) %>%
  dplyr::mutate(Age = Age * 1000)  %>%
  dplyr::filter(Age <= 20000)

alley2000 %>%
  ggplot(aes(x = Age, y = Temperature)) +
  geom_line() +
  scale_x_reverse(breaks = seq(0, 20000, 2500)) +
  theme_classic() +
  xlab("calibrated years BP") +
  ylab("Temperature °C") +
  annotate(
    "rect",
    xmin = 11500,
    xmax = 12800,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 12150,
    y = -27.25,
    label = "Younger \n Dryas",
    size = 3.5
  ) +
  geom_segment(aes(
    x = 8200,
    y = -36.5,
    xend = 8200,
    yend = -33
  ),
  arrow = arrow(length = unit(0.3, "cm"))) +
  annotate(
    "text",
    x = 8200,
    y = -38,
    label = "8200 cal yr BP \n cold event",
    size = 3
  ) +
  annotate(
    "rect",
    xmin = 4000,
    xmax = 6000,
    ymin = min(alley2000$Temperature) - 0.5,
    ymax = max(alley2000$Temperature),
    alpha = .2
  ) +
  annotate(
    "text",
    x = 5000,
    y = -27.25,
    label = "northward expansion \n of agriculture",
    size = 3
  ) 

# Warmest periods following 5000 BP.
# 3297.07     -28.748
# 2068.24    -29.5708
# 1514.860    -30.4060
# 964.939    -30.4628


# To visualize in BC/AD.
# alley2000 %>%
#   dplyr::filter(Age <= 3000) %>% 
#   dplyr::mutate(date = BPtoBCAD(Age)) %>% 
#   ggplot(aes(x = date, y = Temperature)) +
#   geom_line() +
#   scale_x_continuous(breaks = seq(-1200, 2000, 200)) +
#   theme_classic() +
#   xlab("calibrated years BP") +
#   ylab("Temperature °C") 


```


```{r fig3, fig.cap="Low-frequency component of Moberg et al. (2005) multi-proxy reconstruction for Northern Hemisphere for 1817-25 BP.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Moberg et al. 2005 low-frequency reconstruction (only).
Moberg <-
  read.delim(
    "./data-raw/nhtemp-moberg2005.txt",
    header = TRUE,
    sep = "\t",
    dec = "."
  ) [, 1:3] %>%
  dplyr::filter(LF != -9.9999 & date <= 2000) %>%
  dplyr::mutate(date = 1950 - date)

ggplot(data = Moberg, aes(x = date, y = LF)) +
  geom_line(size = 1.5) +
  xlab("calibrated years BP") +
  ylab("Temperature Anomaly (°C)") +
  #scale_x_continuous(breaks=seq(0,2000,200), minor_breaks = seq(100, 1900, 200)) +
  scale_x_reverse(breaks = seq(0, 2000, 200),
                  minor_breaks = seq(100, 1900, 200)) +
  scale_y_continuous(breaks = seq(-0.8, 0, 0.1), limits = c(-0.8, 0)) +
  theme_bw() +
  geom_vline(xintercept = c(1067, 800, 660, 360)) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 4,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 4,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "grey 70"),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 10,
      b = 5,
      l = 5
    )
  )

```


```{r fig4, fig.cap="Low-frequency temperature reconstruction time series for this study.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

# Temperature anomaly across time for the spatial extent in each 100 year interval.
temp_anom <- read.csv("./output/paleomat-temp-anomaly-final.csv")

temp_anom %>%
  ggplot() +
  geom_line(aes(x = year, y = anom), colour = "red", size = 1.0) +
  xlab("Year BC/AD") +
  ylab("July Temperature Anomaly (°C)") +
  scale_x_continuous(breaks = seq(-1000, 1800, 200),
                     minor_breaks = seq((-1000 + 100), (1800 - 100), 200)) +
  scale_y_continuous(breaks = seq(-2.5, 0.0, 0.5),
                     limits = c(-2.5, 0.0)) +
  theme_bw() +
  geom_vline(xintercept = c(883, 1150, 1290, 1590)) +
  annotate(
    "rect",
    xmin = 800,
    xmax = 1200,
    ymin = -2.5,
    ymax = 0.0,
    alpha = .2
  ) +
  annotate(
    "text",
    x = 1000,
    y = -0.25,
    label = "Medieval Warm \n Period",
    size = 4.5
  ) +
    annotate(
    "rect",
    xmin = 1400,
    xmax = 1800,
    ymin = -2.5,
    ymax = 0.0,
    alpha = .2
  ) +
  annotate(
    "text",
    x = 1600,
    y = -0.25,
    label = "Little Ice \n Age",
    size = 4.5
  ) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 6,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 6,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black")
  )


```


```{r fig5, fig.cap="July temperature anomaly from AD 100 to 1800 from this study and of Moberg et al. [2005]. Both time series have been standardized so that they can be compared using (x-mean/std) where x is temperature, the mean is of the individual time series, and the standard deviation is of the individual time series.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

temp_anom_standard <- anom_new %>%
  dplyr::mutate(update = (anom - mean(anom_new$anom)) / sd(anom_new$anom)) %>% 
  dplyr::mutate(Series = "This study") %>% 
  dplyr::select(year, update, Series)

Moberg_standard <- Moberg %>% 
  dplyr::mutate(update = (LF - mean(Moberg$LF)) / sd(Moberg$LF)) %>% 
  dplyr::mutate(year = BPtoBCAD(date)) %>% 
  dplyr::mutate(Series = "Moberg et al. 2005") %>% 
  dplyr::select(year, update, Series)

Moberg_paleomat <- rbind(temp_anom_standard, Moberg_standard)

# Moberg LF and paleomat
Moberg_paleomat %>% 
  dplyr::filter(year >= 133 & year <= 1800) %>% 
  ggplot(aes(x = year, y = update, colour = Series)) +
  geom_line(size = 1.0) +
  xlab("Year BC/AD") +
  ylab("Standardized July Temperature Anomaly") +
  theme_bw() +
  scale_x_continuous(breaks = seq(100, 1800, 100)) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 6,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 6,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black")
  )

```


```{r fig6, fig.cap="The spatial interpolation of the low-frequency temperature reconstruction for this study. The extent can be seen by the red box in Figure 3.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

tavg_rasters <- stack("./output/paleomat-rasters.tif")

# library(ggnewscale)
# 
# # setting up bounding box
# locations <- data.frame(x = c(-112.81446, -105.52416),
#                         y = c(32.65757, 38.089))

# -112.81446,
#     "xmax" = -105.52416,
#     "ymin" = 32.65757,
#     "ymax" = 38.089

# # get gem
# dem <- get_elev_raster(locations = bb2, prj = sf::st_crs(4326), z = 7, clip = "bbox")
# temp.raster <- raster::crop(temp.raster, bb2)
# temp.raster <-
#   raster::projectRaster(temp.raster, crs = CRS("+init=epsg:4326"))
# 
# # create slope and hillshade
# slope = terrain(dem, opt='slope')
# aspect = terrain(dem, opt='aspect')
# hill = hillShade(slope, aspect, 40, 270)
# hill_spdf <- as(hill, "SpatialPixelsDataFrame")
# hill_spdf <- as.data.frame(hill_spdf)
# colnames(hill_spdf) <- c("value", "x", "y")


rasterVis::gplot(tavg_rasters) +
  # geom_tile(data = hill_spdf, aes(x = x, y = y, fill = value)) +
  geom_tile(aes(fill = value)) +
  facet_wrap(~ variable) +
  scale_fill_gradientn(colours = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255)) +
  coord_equal() +
  theme_bw() +
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill='Anomaly')


# names(tavg_idw) <- c("BC950","BC850","BC750", "BC650", "BC550","BC450", "BC350", "BC250", "BC150", "BC50", "AD50", "AD150", "AD250", "AD350", "AD450", "AD550", "AD650", "AD750", "AD850","AD950", "AD1050", "AD1150", "AD1250", "AD1350", "AD1450", "AD1550", "AD1650", "AD1750")
#
# anomaly_plots <-
#   purrr::map2(
#     .x = tavg_idw, .y = names(tavg_idw),
#     .f =
#       ~plot_map_anomaly(x = .x, x.name = .y, us.cities = us.cities, cities = FALSE, animation = FALSE)
#   )


# temp.raster <-
#   raster::projectRaster(tavg_nrg[[23]], crs = CRS("+init=epsg:4326"))
# 
# 
# usa <- sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
# usa <- sf::st_transform(usa, crs = 4326)
# 
# crs(temp.raster) <-
#   "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs"
# temperature <- as.data.frame(temp.raster, xy = TRUE)
# temperature_transformed <- usmap::usmap_transform(temperature)
# 
# 
# ggplot() +
#   geom_raster(
#     data = temperature_transformed,
#     aes(x = x, y = y, fill = paleomat.rasters.23),
#     alpha = 0.8,
#     na.rm = TRUE
#   ) +
#   scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
#                        #limits = c(-8, 8),
#                        na.value = "transparent",
#                        name = "Temperature °C") +
#   coord_equal() +
#   theme_classic()


```



```{r fig7, fig.cap="July temperature anomaly for two Village Ecodynamics Project (VEP) areas, VEPIIS and VEPIIN (Schwindt et al. 2016).", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

vepii_cmv_boundary <- st_transform(vepii_cmv_boundary, crs = st_crs(4326)) %>% 
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

tavg_cmv <- brick("./output/paleomat-rasters.tif") %>%
  unstack() %>% 
  purrr::map(., raster::crop, vepii_cmv_boundary)

vepii_nrg_boundary <- st_transform(vepii_nrg_boundary, crs = st_crs(4326)) %>% 
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

tavg_nrg <- brick("./output/paleomat-rasters.tif") %>%
  unstack() %>% 
  purrr::map(., raster::crop, vepii_nrg_boundary)

# Calculate the anomaly across time for CMV (or VEPIIN) (to produce line graph).
anom_cmv <- purrr::map(tavg_cmv, cellStats, mean) %>% 
  as.data.frame() %>% 
  tidyr::pivot_longer(cols = 1:28) %>% 
  dplyr::mutate(name = seq(-950, 1750, 100)) %>% 
  dplyr::rename(year = name, anom = value) %>% 
  dplyr::mutate(Series = "VEPIIN")
  
# anom_cmv <- anom_cmv %>%
#   dplyr::mutate(updated = (anom - mean(anom_cmv$anom)) / sd(anom_cmv$anom)) %>% 
#   dplyr::mutate(series = "CMV")

# Calculate the anomaly across time for NRP (or VEPIIS) (to produce line graph).
anom_nrg <- purrr::map(tavg_nrg, cellStats, mean) %>% 
  as.data.frame() %>% 
  tidyr::pivot_longer(cols = 1:28) %>% 
  dplyr::mutate(name = seq(-950, 1750, 100)) %>% 
  dplyr::rename(year = name, anom = value) %>% 
  dplyr::mutate(Series = "VEPIIS")
  
# anom_nrg <- anom_nrg %>%
#   dplyr::mutate(updated = (anom - mean(anom_nrg$anom)) / sd(anom_nrg$anom)) %>% 
#   dplyr::mutate(series = "NRG")

VEPII <- rbind(anom_cmv, anom_nrg)


# Plot both together
VEPII %>%
  #dplyr::filter(year > 0) %>% 
  ggplot(aes(x = year, y = anom, colour=Series)) +
  geom_line(size = 1.0) +
  xlab("Year BC/AD") +
  ylab("July Temperature Anomaly (°C)") +
  scale_x_continuous(breaks = seq(-1000, 1800, 200),
                     minor_breaks = seq((-1000 + 100), (1800 - 100), 200)) +
  scale_y_continuous(breaks = seq(-2.5, 1.0, 0.5),
                     limits = c(-2.5, 1.0)) +
  theme_bw() +
  # annotate(
  #   "rect",
  #   xmin = 800,
  #   xmax = 1200,
  #   ymin = -2.5,
  #   ymax = 0.0,
  #   alpha = .2
  # ) +
  # annotate(
  #   "text",
  #   x = 1000,
  #   y = -0.25,
  #   label = "Medieval Warm \n Period",
  #   size = 4.5
  # ) +
  #   annotate(
  #   "rect",
  #   xmin = 1400,
  #   xmax = 1800,
  #   ymin = -2.5,
  #   ymax = 0.0,
  #   alpha = .2
  # ) +
  # annotate(
  #   "text",
  #   x = 1600,
  #   y = -0.25,
  #   label = "Little Ice \n Age",
  #   size = 4.5
  # ) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 6,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 6,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_line(colour = "light grey"),
    axis.line = element_line(colour = "black")
  )


```

```{r fig8, fig.cap="Comparison of low-frequency reconstruction from this study, crop productivity, and niche.", fig.width=10.5, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

years <- 1:1300

paleomat <-
  read.csv(file = "./output/paleomat-temp-anomaly-final.csv", header = TRUE) %>%
  dplyr::filter(year >= 1 & year <= 1250)

paleomat <- paleomat %>% 
  dplyr::mutate(updated = (anom - mean(paleomat$anom)) / sd(paleomat$anom))

# Estimated potential average maize yield (kg) in the CMV region
years_vep <- data.frame(Year = seq(1, 599, 1))
vep_paleoprod_mean <-
  read.csv("./data-raw/vepiin_paleoprod_stats.csv")
vep_paleoprod_mean <-
  dplyr::bind_rows(years_vep, vep_paleoprod_mean)

vep_paleoprod_mean <- vep_paleoprod_mean %>% 
  dplyr::mutate(updated = (`Average.prod..linear.lagged.` - mean(vep_paleoprod_mean$`Average.prod..linear.lagged.`, na.rm = TRUE)) / sd(vep_paleoprod_mean$`Average.prod..linear.lagged.`, na.rm = TRUE))


# Proportion of the CMV region in the maize dry-farming niche
vep_niche_percent <- read.csv("./data-raw/vepiin_niche_stats.csv")

vep_niche_percent <- vep_niche_percent %>% 
  dplyr::mutate(updated = (`Prop.in.niche..linear.lagged.` - mean(vep_niche_percent$`Prop.in.niche..linear.lagged.`, na.rm = TRUE)) / sd(vep_niche_percent$`Prop.in.niche..linear.lagged.`, na.rm = TRUE))


all_reconstructions <- vep_paleoprod_mean %>%
  dplyr::select(Year, `Average.prod..linear.lagged.`) %>%
  dplyr::rename(
    "Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
  ) %>%
  dplyr::left_join(
    vep_niche_percent %>% dplyr::select(Year, `Prop.in.niche..linear.lagged.`) %>% dplyr::rename(
      "Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
    ),
    by = "Year"
  ) %>%
  dplyr::left_join(
    paleomat %>% dplyr::rename(
      "Year" = 1,
      "MAT - Temperature Anomaly °C (100-year Intervals)" = 2
    ) ,
    by = "Year"
  ) %>%
  tidyr::pivot_longer(!Year, "Measure", "value") %>%
  dplyr::filter(!is.na(value))

all_reconstructions$Measure_f = factor(
  all_reconstructions$Measure ,
  levels = c(
    'Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
    'MAT - Temperature Anomaly °C (100-year Intervals)'
  )
)


ggplot(all_reconstructions, aes(x = Year)) +
  geom_line(aes(y = value)) +
  scale_x_continuous(
    breaks = c(1, seq(100, 1300, 100)),
    limits = c(1, 1300),
    expand = c(0, 0)
  ) +
  ggplot2::xlab("Year AD") +
  ggplot2::ylab("") +
  ggplot2::theme_linedraw() +
  facet_wrap("Measure_f",
             ncol = 1,
             scales = "free_y") +
  guides(fill = FALSE, color = FALSE) +
  theme(text = element_text(size = 15),
        plot.margin = margin(10, 15, 10, 10))






# plot together using the standardized values.
# all_reconstructions <- vep_paleoprod_mean %>%
#   dplyr::select(Year, updated) %>%
#   dplyr::rename(
#     "Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
#   ) %>%
#   dplyr::left_join(
#     vep_niche_percent %>% dplyr::select(Year, updated) %>% dplyr::rename(
#       "Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])" = 2
#     ),
#     by = "Year"
#   ) %>%
#   dplyr::left_join(
#     paleomat %>% dplyr::select(year, updated) %>% 
#       dplyr::rename(
#       "Year" = 1,
#       "MAT - Temperature Anomaly °C (100-year Intervals)" = 2
#     ) ,
#     by = "Year"
#   ) %>%
#   tidyr::pivot_longer(!Year, "Measure", "value") %>%
#   dplyr::filter(!is.na(value))
# 
# all_reconstructions$Measure_f = factor(
#   all_reconstructions$Measure ,
#   levels = c(
#     'Average Crop Productivity (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
#     'Proportion in Maize Niche (Unweighted Average of the Current Year and the Previous 20 [i.e., linear lagged])',
#     'MAT - Temperature Anomaly °C (100-year Intervals)'
#   )
# )
# 
# ggplot(all_reconstructions, aes(x = Year, y = value, colour = Measure)) +
#   geom_line() +
#   scale_x_continuous(
#     breaks = c(1, seq(100, 1300, 100)),
#     limits = c(1, 1300),
#     expand = c(0, 0)
#   ) +
#   ggplot2::xlab("Year AD") +
#   ggplot2::ylab("") +
#   theme(legend.position = "none") +
#   theme(text = element_text(size = 15),
#         plot.margin = margin(10, 15, 10, 10))


```



# Tables

```{r table1, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='asis'}

fossil.locs2 <-
    readr::read_rds(here::here("./vignettes/data/reconst_tavg_final_west_3.rds")) %>% dplyr::filter(month == 7) %>% 
  dplyr::select(-c(month, type, pub_year, value, error, sample.id)) %>% 
  dplyr::ungroup() %>% 
  tidyr::extract(geometry, c('long', 'lat'), '\\((.*), (.*)\\)', convert = TRUE) %>% 
  dplyr::group_by(dataset.id, site.id, site.name) %>% 
  summarise(minAge = min(age), maxAge = max(age), minDepth = min(depth), maxDepth = max(depth), across(c(long, lat, elev), unique)) %>% 
  dplyr::select(site.name, site.id, dataset.id, minAge, maxAge, minDepth, maxDepth, long, lat, elev) %>% 
  dplyr::arrange(site.name) %>% 
  dplyr::rename("Site Name" = site.name, "Site ID" = site.id, "Dataset ID" = dataset.id, "Earliest date of core (BP)" = minAge, "Latest date of core (BP)" = maxAge, "Minimum Depth" = minDepth, "Maximum Depth" = maxDepth, "Longitude" = long, "Latitude" = lat, "Elevation (m)" = elev )

#write.csv(fossil.locs2, "./vignettes/data/fossil.locations.csv", row.names = FALSE)

knitr::kable(fossil.locs2,
             caption = "Metadata for the fossil pollen records used in this study.")

```



# Supplementary Figures

```{r supp_fig1, fig.cap="Temporal interpolation of temperature reconstruction for each fossil pollen site.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

temporal_interpolations <- readRDS("./output/temporal_interpolations.rds")

# Plot results in one PDF.
plot_objects <- temporal_interpolations$plot_fit
names(plot_objects) <- c(temporal_interpolations$site.name)

ok <- ggpubr::ggarrange(plotlist= plot_objects,
                    labels = c(names(plot_objects)),
                    ncol = 4, nrow = 9, vjust = -0.5)

annotate_figure(ok, top = text_grob("", 
               color = "red", face = "bold", size = 14))

# plot_objects_arranged <- gridExtra::marrangeGrob(plot_objects, nrow=7, ncol=5, top=quote(names(plot_objects)[g]))
# ggsave("./output/temporal_interpolations_plots.pdf", plot_objects_arranged, scale = 1.5)


# Plot anomaly through time for each site.
site_anomaly <- site.preds.unlisted.anom %>% 
  dplyr::group_by(site.id) %>%
  tidyr::nest()


int_anom_plot <- function(x) {
  ggplot(data = x,
         aes(x = date,
             y = anom)) +
    geom_line(colour = "red", size = 1.0) +
    xlab("Year BC/AD") +
    ylab("Temperature Anomaly (°C)") +
    scale_x_continuous(breaks = seq(-1000, 1800, 200),
                       minor_breaks = seq((-1000 + 100), (1800 - 100), 200)) +
    # scale_y_continuous(breaks = seq((
    #   DescTools::RoundTo(min(fit$value), multiple = 0.5, FUN = floor)
    # ), (
    #   DescTools::RoundTo(max(fit$value), multiple = 0.5, FUN = ceiling)
    # ), 0.5)) +
    theme_bw() +
    theme(
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      axis.text = element_text(
        size = 10,
        colour = "black",
        family = "Helvetica"
      ),
      axis.title.y = element_text(
        size = 12,
        family = "Helvetica",
        margin = margin(
          t = 10,
          r = 20,
          b = 10,
          l = 10
        )
      ),
      axis.title.x = element_text(
        size = 12,
        family = "Helvetica",
        margin = margin(
          t = 20,
          r = 10,
          b = 10,
          l = 10
        )
      ),
      panel.grid.minor = element_line(colour = "light grey"),
      axis.line = element_line(colour = "black"),
      legend.text = element_text(size = 10, family = "Helvetica"),
      legend.title = element_text(size = 11, family = "Helvetica")
    )
}


plot_objects2 <- purrr::map(site_anomaly$data, int_anom_plot)

ok3 <- purrr::map(plot_objects2, 1) 
ok3 <- lapply(ok3, `[[`, 2)
ok3 <- lapply(ok3, `[`, 1) %>% unlist()

names(plot_objects2) <- c(ok3)


ok2 <- ggpubr::ggarrange(plotlist= plot_objects2,
                    labels = c(names(plot_objects2)),
                    ncol = 4, nrow = 9, vjust = -0.5)

annotate_figure(ok2, top = text_grob("", 
               color = "red", face = "bold", size = 14))

```


```{r supp_fig2, fig.cap="Modern samples in North America.", echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all'}

library(tidyverse)
library(rnaturalearth)
library(sf)
library(ggtext)

dat <- MPCT_metadata_counts_final %>% 
  dplyr::select(c(dataset.id, geometry, PINUSX)) %>% 
  filter(!is.na(PINUSX))

usa2 <- st_cast(usa, "POLYGON") %>%
  mutate(mapcolor7 = sample(1:7, n(), replace = TRUE))


usa2$fill <- as.factor(usa2$ID)
usa2$fill <- c("#F9D8D6", "#CDF5F6", "#F9EBDF", "#EFD2AC", "#f9d6f7", "#d6f9d8", "#f7f9d6")[usa2$mapcolor7]
usa2$stroke <- 2
usa2$fillweight <- 4.0

# MULTIPOLYGON (and also MULTILINESTRING) are not supported
usa2 <- st_cast(usa2, "POLYGON")


dat <- st_sf(dat)
st_crs(dat) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
dat$size <- 8
dat$color <- "#000000"
# dat$label <- cities$name
# dat$label_pos <- "e"


dat1 <- dat
dat1$size <- ambient::normalise((dat1$PINUSX))
dat1$radius <- dat1$size / 10
st_crs(dat1) <- st_crs(usa)
dat1$size <- ambient::normalise(dat1$size, to = c(10, 30))
st_crs(dat1) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
dat1$color <- "red"


roughsf_map <- roughsf::roughsf(list(usa2, dat1),
                 title = "Modern Pine Pollen Samples across the United States", caption = "*Points are scaled based on the count of pine pollen grains at each site. Data are from the Neotoma Paleoecology Database.",
                 title_font = "48px Pristina", font = "30px Pristina", caption_font = "18px Pristina",
                 roughness = 1, bowing = 1, simplification = 1,
                 width = 1600, height = 1000, 
)

roughsf::save_roughsf(roughsf_map, "roughsf_map.png")


europe <- ne_countries(scale = 50, continent = "North America", returnclass = "sf")

europe$fill <- as.factor(europe$mapcolor7)
dat$size <- ambient::normalise(log(dat$PINUSX))
dat$radius <- dat$size / 10

newloc <- packcircles::circleRepelLayout(select(dat, long, lat, radius))
dat1 <- bind_cols(dat, newloc$layout[, -3])


map_title <- "<span style='font-size:32pt;'>Figurative Map of the Cargo Tonnage of the Major Ports of Europe</span>"
p <- ggplot() +
  geom_sf(data = europe, aes(fill = fill), show.legend = FALSE, size = 0.1) +
  # geom_sf_text(
  #   data = europe[europe$pop_est > 8e6 & !europe$name_long %in% c("Netherlands", "Belgium", "Portugal"), ],
  #   aes(label = name_long), size = 10, family = "EB Garamond 08"
  # ) +
  geom_point(data = dat1, aes(x, y, size = I(size)), show.legend = FALSE, shape = 21, fill = "darkgreen") +
  geom_text(data = dat1, aes(x, y, size = I(size / 3), label = PINUSX), family = "EB Garamond 08") +
  #geom_text(data = dat1, aes(x, y, label = city), size = 2, vjust = -dat$size / 3, family = "EB Garamond 08") +
  scale_fill_manual(values = c("#F9D8D6", "#CDF5F6", "#F9EBDF", "#EFD2AC", "#f9d6f7", "#d6f9d8", "#f7f9d6")) +
  coord_sf(expand = FALSE, xlim = c(-10, 50), ylim = c(35, 75)) +
  # title
  annotate("richtext",
    x = -Inf, y = Inf, hjust = 0, vjust = 1, label = map_title,
    size = 8, fill = "#e8e4c9", family = "EB Garamond 08",
    label.padding = unit(c(3.25, 1.0, 3.0, 1.0), "lines")
  ) +
  # caption
  annotate("richtext",
    x = Inf, y = -Inf, hjust = 1, vjust = 0, label = "<span style='font-size:22pt'>@schochastics</span>",
    size = 12, fill = NA, family = "EB Garamond 08", label.color = NA,
    label.padding = unit(c(0.2, 0.2, 0.2, 0.2), "lines")
  ) +
  theme_void() +
  theme(
    plot.title = element_text(family = "EB Garamond 08", size = 46, hjust = 0, margin = margin(0, 0, 0, 0)),
    plot.background = element_rect(fill = "#e8e4c9", colour = "black", size = 0.5),
    panel.background = element_rect(fill = "#e8e4c9", colour = "black", size = 0.1)
  )

ragg::agg_png("13_naturalearth.png", width = 1500, height = 1500)
p
dev.off()

europe <- ne_countries(scale = 110, continent = "North America", returnclass = "sf")
europe$fill <- c("#F9D8D6", "#CDF5F6", "#F9EBDF", "#EFD2AC", "#f9d6f7", "#d6f9d8", "#f7f9d6")[europe$mapcolor7]
europe$fillweight <- 2
europe$label <- ""
keep <- c("Spain", "Germany", "Poland", "Austria", "Hungary", "Romania")
europe <- st_cast(europe, "POLYGON")
europe_crop <- st_crop(europe, st_polygon(list(matrix(c(-10, 32, 50, 32, 50, 70, -10, 70, -10, 32), ncol = 2, byrow = TRUE))))

dat1 <- dat1 %>% st_as_sf(coords = c("long", "lat"))
st_crs(dat1) <- st_crs(europe)
dat1$size <- ambient::normalise(dat1$size, to = c(10, 30))
dat1_crop <- st_crop(dat1, st_polygon(list(matrix(c(-10, 32, 50, 32, 50, 75, -10, 75, -10, 32), ncol = 2, byrow = TRUE)))) %>%
  dplyr::filter(y >= 35)
dat1_crop$color <- "red"

water <- data.frame(name = "water")
water$geometry <- st_sfc(st_polygon(list(matrix(c(-10, 32, 50, 32, 50, 73, -10, 73, -10, 32), ncol = 2, byrow = TRUE))))
water <- st_sf(water)
st_crs(water) <- st_crs(europe)
water$fill <- "#006994"
water$fillstyle <- "cross-hatch"
water$fillweight <- 0.1
water$stroke <- 5

europe_bg <- europe_crop
europe_bg$fill <- "#ffffff"
europe_bg$fillstyle <- "solid"
pst <- roughsf::roughsf(list(water, dat1_crop),
  title = "Ports of Europe", title_font = "94px Pristina",
  caption = "(data from naturalearth) drawn by @schochastics", caption_font = "40px Pristina",
  width = 2500, height = 2500
)
pst
roughsf::save_roughsf(pst, "13_naturalearth.png")

```

