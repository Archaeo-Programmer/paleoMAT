---
title: "Data Visualization for Upland United States Southwest Pollen-based Climate Reconstruction"
author: "Andrew Gillreath-Brown"
date: "5/3/2021"
mainfont: Calibri
output:
  html_document:
    code_folding: show
    keep_md: yes
    number_sections: yes
    theme: sandstone
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# devtools::install()
# devtools::load_all()
library(paleomat)

```

# Load the final reconstruction data.

```{r load_data, echo = FALSE, message=FALSE, warning=FALSE, results='hide'}

# Load tavg data.
if(file.exists(here::here("vignettes/data/reconst_tavg_final.rds"))) {
  reconst_tavg_final <-
    readr::read_rds(here::here("vignettes/data/reconst_tavg_final.rds"))
} else {
  stop(
    "The final output file for the reconstruction has not been made. Please return to the UUSS_MAT_Reconstruction.RMD to complete the reconstruction."
  )
  
}

# Load GDD data.
if(file.exists(here::here("vignettes/data/reconst_gdd_final.rds"))) {
  reconst_gdd_final <-
    readr::read_rds(here::here("vignettes/data/reconst_gdd_final.rds"))
} else {
  stop(
    "The final output file for the reconstruction has not been made. Please return to the UUSS_MAT_Reconstruction.RMD to complete the reconstruction."
  )
  
}

# Now, extract out the maize growing season months for GDD.
reconst_GDD_total <- reconst_gdd_final %>% 
  dplyr::filter(month >= 5 & month <= 9) %>% 
  dplyr::group_by(dataset.id, sample.id, depth) %>% 
  dplyr::summarise_at(c("value", "error"), tibble::lst(sum, mean)) %>% 
  dplyr::select(dataset.id, sample.id, depth, value_sum, error_mean)

reconst_GDD_total_meta <- reconst_gdd_final %>% 
  dplyr::filter(month == 5) %>%
  dplyr::select(-c(value, error, month))

UUSS_GDD <- left_join(reconst_GDD_total_meta, reconst_GDD_total, by = c("dataset.id", "sample.id", "depth"))

```

# Summarize the results.

```{r summarize, echo=FALSE}

# First, convert the years BP in the age column to BC/AD dates, which we create a new column called date.
reconst_tavg_final <- reconst_tavg_final %>% 
  dplyr::mutate(date = paleomat::BPtoBCAD(reconst_tavg_final$age))

UUSS_GDD <- UUSS_GDD %>% 
  dplyr::mutate(date = paleomat::BPtoBCAD(UUSS_GDD$age))

# Do 100 year average temperatures across growing season months (May through September).
UUSS_100yrAvgs_tavg_GS <- reconst_tavg_final %>% 
     dplyr::filter(month >= 5 & month <= 9) %>%
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value", "error", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_n, elev_n, error_unique_sites, error_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

# Do 100 year average temperatures for the warmest month of the year, July.
UUSS_100yrAvgs_tavg_July <- reconst_tavg_final %>% 
     dplyr::filter(month == 7) %>% 
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value", "error", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_n, elev_n, error_unique_sites, error_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

# Calculate GDD for the growing season (May through September).
UUSS_100yrAvgs_GDD <- UUSS_GDD %>% 
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value_sum", "error_mean", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_mean_n, elev_n, error_mean_unique_sites, error_mean_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

```

# Plotting the results. 

```{r plot_reconst, fig.width=8, fig.height=9, echo=FALSE}




```

