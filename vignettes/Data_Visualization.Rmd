---
title: "Data Visualization for Upland United States Southwest Pollen-based Climate Reconstruction"
author: "Andrew Gillreath-Brown"
date: "5/3/2021"
mainfont: Calibri
output:
  html_document:
    code_folding: show
    keep_md: yes
    number_sections: yes
    theme: sandstone
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# devtools::install()
# devtools::load_all()
library(paleomat)

```

# Load the final reconstruction data.

```{r load_data, echo = FALSE, message=FALSE, warning=FALSE, results='hide'}

# Load tavg data.
if(file.exists(here::here("vignettes/data/reconst_tavg_final.rds"))) {
  reconst_tavg_final <-
    readr::read_rds(here::here("vignettes/data/reconst_tavg_final.rds"))
} else {
  stop(
    "The final output file for the reconstruction has not been made. Please return to the UUSS_MAT_Reconstruction.RMD to complete the reconstruction."
  )
  
}

# Load GDD data.
if(file.exists(here::here("vignettes/data/reconst_gdd_final.rds"))) {
  reconst_gdd_final <-
    readr::read_rds(here::here("vignettes/data/reconst_gdd_final.rds"))
} else {
  stop(
    "The final output file for the reconstruction has not been made. Please return to the UUSS_MAT_Reconstruction.RMD to complete the reconstruction."
  )
  
}

# Now, extract out the maize growing season months for GDD.
reconst_GDD_total <- reconst_gdd_final %>% 
  dplyr::filter(month >= 5 & month <= 9) %>% 
  dplyr::group_by(dataset.id, sample.id, depth) %>% 
  dplyr::summarise_at(c("value", "error"), tibble::lst(sum, mean)) %>% 
  dplyr::select(dataset.id, sample.id, depth, value_sum, error_mean)

reconst_GDD_total_meta <- reconst_gdd_final %>% 
  dplyr::filter(month == 5) %>%
  dplyr::select(-c(value, error, month))

UUSS_GDD <- left_join(reconst_GDD_total_meta, reconst_GDD_total, by = c("dataset.id", "sample.id", "depth"))

```

# Summarize the results.

```{r summarize, echo=FALSE}

# First, convert the years BP in the age column to BC/AD dates, which we create a new column called date.
reconst_tavg_final <- reconst_tavg_final %>% 
  dplyr::mutate(date = paleomat::BPtoBCAD(reconst_tavg_final$age))

UUSS_GDD <- UUSS_GDD %>% 
  dplyr::mutate(date = paleomat::BPtoBCAD(UUSS_GDD$age))

# Do 100 year average temperatures across growing season months (May through September).
UUSS_100yrAvgs_tavg_GS <- reconst_tavg_final %>% 
     dplyr::filter(month >= 5 & month <= 9) %>%
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value", "error", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_n, elev_n, error_unique_sites, error_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

# Do 100 year average temperatures for the warmest month of the year, July.
UUSS_100yrAvgs_tavg_July <- reconst_tavg_final %>% 
     dplyr::filter(month == 7) %>% 
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value", "error", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_n, elev_n, error_unique_sites, error_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

# Calculate GDD for the growing season (May through September).
UUSS_100yrAvgs_GDD <- UUSS_GDD %>% 
     dplyr::filter(age < 5000) %>% 
     dplyr::group_by(period=cut(date, breaks=seq(-3100,2100,100))) %>% 
     dplyr::summarise_at(c("value_sum", "error_mean", "elev"), funs(mean, n = n(), unique_sites = dplyr::n_distinct(site.id), unique_datasets = dplyr::n_distinct(dataset.id))) %>%
     dplyr::arrange(as.numeric(period)) %>% 
     dplyr::select(-c(error_mean_n, elev_n, error_mean_unique_sites, error_mean_unique_datasets, elev_unique_sites, elev_unique_datasets)) %>% 
     dplyr::mutate(midP = seq(-3050, 2050, 100))

```

# Plotting the results. 

```{r plot_reconst, fig.width=8, fig.height=9, echo=FALSE}

UUSS_100yrAvgs_tavg_GS_plot <- ggplot(data=(dplyr::filter(UUSS_100yrAvgs_tavg_GS[1:50, ])), aes(x=midP, y=value_mean, label = value_n, label2 = value_unique_sites)) + 
  #scale_color_gradient(low="blue", high="red") +
  geom_ribbon(aes(x=midP, ymin = value_mean - error_mean,
                  ymax = value_mean + error_mean,
                  alpha = 0.2),
              fill = "grey",
              colour="dark grey", 
              show.legend = F ) +
  geom_line(colour="red", size = 3.0) +
  xlab("Year BC/AD") +
  ylab("Temperature °C") +
  scale_x_continuous(breaks=seq(-3100,2100,200), minor_breaks = seq(-3000, 2000, 200)) +
  scale_y_continuous(breaks=seq(6,19,1), limits = c(6, 19)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), axis.text=element_text(size=18, colour = "black", family = "Helvetica"), axis.title.y = element_text(size = 28, family = "Helvetica", margin = margin(t = 10, r = 20, b = 10, l = 10)), axis.title.x = element_text(size = 28, family = "Helvetica", margin = margin(t = 20, r = 10, b = 10, l = 10)),
        panel.grid.minor = element_line(colour = "light grey"), axis.line = element_line(colour = "black"), legend.text = element_text(size = 18, family = "Helvetica"), legend.title = element_text(size = 22, family = "Helvetica")) +
  labs(col = "Temperature (°C)")

# Save the plot for GS.
ggsave(UUSS_100yrAvgs_tavg_GS_plot, file = "UUSS_100yrAvg_GrowingSeason_Temperature.pdf", path = "vignettes/figures", units="in", width=21, height=13)



```

